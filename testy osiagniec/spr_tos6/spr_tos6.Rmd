---
title: "Przyłączanie sprawdzianu do SUEKowych uczniów"
author: "Michał Modzelewski"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
# setwd("~/SUEK/Projects/suek/testy osiagniec/spr_tos6")
library(plyr)
options(width = 90)
source("R/join_var.R")
```

# Wczytanie baz danych

```{r}

# sprawdzian
spr14 = read.csv2("data/sprawdzian_2014.csv", stringsAsFactors = FALSE)

# protokoł
suek_u = read.csv2("data/prot.csv", stringsAsFactors = FALSE)

# id_szkoly
suek_s = read.csv2("data/calosc.csv", stringsAsFactors = FALSE)
names(suek_s) = c("id_szk", "id_cke_s")

# rodzice etap 1
rodz_e1 = read.csv2("data/e1_rodzic.csv", stringsAsFactors = FALSE)[, c(1, 3)]
names(rodz_e1) = c("id_ucz", "data_ur")

# rodzice etap 2
rodz_e2 = read.csv2(paste0("data/SUEK II, ankiety rodziców, I etap, ",
                           "ankieta głównaDane.csv"),
                    stringsAsFactors = FALSE)[, c(3, 5)]
names(rodz_e2) = c("id_ucz", "data_ur")

# rodzice etap 3
rodz_e3 = read.csv2(paste0("data/SUEK E3 Baza ankiet rodziców",
                           " - niebieskie pełne CÓRKA Dane.csv"),
                    stringsAsFactors = FALSE)[, c(2, 4)]
names(rodz_e3) = c("id_ucz", "data_ur")

# rodzice etap 3 uzuepłniająca ankieta
rodz_e3u = read.csv2(paste0("data/SUEK E3 Baza ankiet rodziców",
                           " - niebieskie skrócone Dane.csv"),
                    stringsAsFactors = FALSE)[, c(2, 4)]
names(rodz_e3u) = c("id_ucz", "data_ur")

```

# Obróbka danych

1. Wyrzucenie uczniów, dla których nie zebrano informacji o numerze z dziennika.

```{r}
# wyrzucenie uczniow o nrze z dziennika 97
suek_u = suek_u[suek_u$nr_dz6 != 97, ]

```

2. Poprawienie formatu daty urodzenia w bazach rodzicielskich z etapu 1, 2 i 3. Obcięcie godzin oraz zamiana "-" na ".".

```{r}
# obcięcie godzin i podmiana separatorów
# etap 1
rodz_e1$data_ur = gsub("-", ".", substr(rodz_e1$data_ur, 1, 10))
# etap 2
rodz_e2$data_ur = gsub("-", ".", substr(rodz_e2$data_ur, 1, 10))
# etap 3
rodz_e3$data_ur = gsub("-", ".", substr(rodz_e3$data_ur, 1, 10))
rodz_e3u$data_ur = gsub("-", ".", substr(rodz_e3u$data_ur, 1, 10))
```

3. Przyłączenie id\cke do uczniów.

```{r}
# przylaczenie id cke do uczniow
suek = merge(suek_u, suek_s, all.x = TRUE)

```

4. Poprawienie id\_cke dla szkoły w Pilchowie. W naszych bazach figuruje jako szkoła w Tanowie (ID 034), klasa "B". Jest to jednak filia szkoły w Tanowie, czyli całkiem zewnętrzny byt. W związku z tym trzeba zmienić id\_cke, a także oznaczenie klasy na "A". 

```{r}
# podmiana ID CKE dla szkoły w pilchowie, ID 34 klasa B
suek[grep("^034.B", suek$id_ucz), "id_cke_s"] = "321104-11P1X"
suek[grep("^034.B", suek$id_ucz), "id_klasa6"] = "A"

```

5. Stworzenie identyfikatora dla klas w bazach sprawdzianowych i suekowych

```{r}
suek$id_cke_kl = paste(suek$id_cke_s, suek$id_klasa6, sep = "_")
spr14$id_cke_kl = paste(spr14$kod_s, spr14$klasa_s, sep = "_")
                          
```

6. Poprawienie identyfikatora uczniow z ankiety z etapu II

```{r}
id_list = strsplit(rodz_e2$id_ucz, ".", fixed = TRUE)
rodz_e2$id_ucz = sapply(id_list, function(x) {
    szk = sprintf("%03d", as.numeric(x[1]))
    kl = substr(x[2], 1, 1)
    ucz = x[4]
    paste(szk, kl, ucz, sep = ".")
  })

```

6. Przyłączenie daty urodzenia do bazy suekowej.

```{r}
# przylaczenie daty urodzenia
suek1 = merge(suek, rodz_e1, all.x = TRUE)

# uczniowie dla których nie ma daty urodzenia z pierwszego etapu
id_miss = suek1[is.na(suek1$data_ur), "id_ucz"]

# sprawdzenie czy uczniowie ci są obecni w innych bazach
any(id_miss %in% rodz_e2$id_ucz)
any(id_miss %in% rodz_e3$id_ucz)
any(id_miss %in% rodz_e3u$id_ucz)

# odjęcie uczniów, których nie ma w bazie z 3 etapu
id_3 = id_miss[id_miss %in% rodz_e3$id_ucz]

# dopisanie dat urodzenia dla uczniów z 3 etapu
suek1[match(id_3, suek1$id_ucz), "data_ur"] =
  rodz_e3[match(id_3, rodz_e3$id_ucz), "data_ur"]

# odjęcie uczniów, których nie ma w bazie z 3 etapu (ankieta uzup)
id_3u = id_miss[id_miss %in% rodz_e3u$id_ucz]

# dopisanie dat urodzenia dla uczniów z 3 etapu
suek1[match(id_3u, suek1$id_ucz), "data_ur"] =
  rodz_e3[match(id_3u, rodz_e3u$id_ucz), "data_ur"]

```

7. Wybranie klas suekowych z bazy sprawdzianowej oraz ograniczenie zakresu zbiorów do zmiennych identyfikujących.

```{r}
zm_spr = c("kod_u_s", "plec", "data_ur", "id_cke_kl")
spr = spr14[spr14$id_cke_kl %in% unique(suek$id_cke_kl), zm_spr]

# write.csv2(spr, "data/sprawdzian_suek.csv", row.names = FALSE)

zm_suek = c("imie_nazwisko", "nr_dz6", "plec", "data_ur", "id_cke_kl", "id_ucz")
suek2 = suek1[, zm_suek]

# posortowanie uczniów w obrębie klasy po nr z dziennika
suek2 = suek2[order(suek2$id_cke_kl, suek2$nr_dz6), ]
spr = spr[order(spr$id_cke_kl, spr$kod_u_s), ]
```

# Łączenie sprawdzianu i danych suekowych

W związku z tym, że nie dysponujemy żadnym dobrym identyfikatorem uczniów pomiędzy bazami danych, sprawdzianową i suekową, łączenie przeprowadzono w kilku krokach. Jako zmiennych identyfikujących użyto różnych podzbiorów z grupy trzech zmiennych: nru z dziennika w klasie 6, płci oraz daty urodzenia. Proces łączenia polega na przypisaniu uczniom w bazie suekowej odpowiedniego nru z dziennika w bazie cke (numer ten identyfikuje uczniów jednoznacznie w obrębie klasy), zwanego dalej kodem ucznia.

Nr z dziennika oraz płeć są znane dla każdego ucznia w bazie suekowej. Data urodzenia dla prawie wszystkich uczniów (> 96 %).

```{r}
# odsetek braków danych na dacie urodzenia
length(suek1[is.na(suek1$data_ur), "id_ucz"]) / nrow(suek1)
```

W związku z tym, że płeć oraz data urodzenia są zmiennymi, których wartości mogą się w ramach oddziału powtarzać, na początek przyłączono kod ucznia tym uczniom, dla których te dwie zmienne w jednoznaczny sposób identyfikowały wiersz w bazie cke.

```{r}
# przyłączenie numeru z dziennika z bazy CKE
upd_suek = Map(join_var, dlply(suek2, "id_cke_kl"), dlply(spr, "id_cke_kl"),
               MoreArgs = list(askBy.x = c("nr_dz6", "data_ur", "plec"),
                               askBy.y = c("kod_u_s", "data_ur", "plec"),
                               joinVar = "kod_u_s"))

# odsetek trafień
hits1 = sum(sapply(upd_suek, function(x) {
          length(x$kod_u_s_new[!is.na(x$kod_u_s_new)])
        }))
hits1/ nrow(suek)
```

Tak przeprowadzone łączenie pozwoliło przypisać kod ucznia ponad 87% uczniów. W wyniku działania funkcji w obrębie danej klasy kilku uczniów mogło dostać ten sam kod ucznia. Miało to miejsce w sytuacji, gdy w bazie suekowej wystepowało kilku uczniów o tej samej dacie urodzenia i płci, a w bazie cke występował tylko jeden taki przypadek. Dlatego, w następnym kroku usunięto przypisanie uczniom o tych samej płci i dacie urodzenia w klasie w bazie suekowej.

```{r}
# usunięcie wartości dla dubli w bazie suek
upd_suek_dub = llply(upd_suek, mutate, kod_u_s = kod_u_s_new)
upd_suek2 = Map(join_var, dlply(suek2, "id_cke_kl"), upd_suek_dub,
               MoreArgs = list(askBy.x = c("data_ur", "plec"),
                               joinVar = "kod_u_s",
                               na_rm.y = TRUE))
hits2 = sum(sapply(upd_suek2, function(x) {
          length(x$kod_u_s_new[!is.na(x$kod_u_s_new)])
        }))

# odsetek bez dubli
hits2/ nrow(suek)


```

Następnie, z bazy cke usunięto te kody uczniów, które zostały w jednoznaczny sposób wykorzystane.

```{r}
# usuniecie trafień z bazy cke

# wektory trafień dla oddziałów
hit_list = lapply(upd_suek, function(x) {
    x$kod_u_s_new[complete.cases(x$kod_u_s_new)]
  })

# tworzy listę klas sprawdzianowych
spr_list = dlply(spr, "id_cke_kl")

# aktualizuje listę klas z bazy cke (usuwa przypisane już kody)
spr_2 =  lapply(names(spr_list), function(i) {
    x = spr_list[[i]]
    y = hit_list[[i]]
    
    x[!(x$kod_u_s %in% y), ]
  })

# nadaje nazwy elementom listy
names(spr_2) = names(spr_list)
```

W związku z tym, że dla ok. 13% uczniów nie udało się w jednoznaczny sposób przypisać kodu ucznia po dacie urodzenia i płci, postanowiono przyjrzeć się tym oddziałom, w których odsetek braków danych pozostał bardzo wysoki, podobnie jak liczba niewykorzystanych kodów wg bazy cke.

```{r}
# liczbności braków danych dla bazy suek (po uzupełnieniu)
suek_bd = ldply(upd_suek3a, function(x) {
    n_ucz = nrow(x)
    bd_n = sum(!complete.cases(x$kod_u_s_new))
    data.frame(n_ucz = n_ucz, bd_n = bd_n, bd_ratio = bd_n/n_ucz)
  })
# liczby nieprzypisanych kodów w klasie w bazie cke
cke_bd = ldply(spr_2, nrow)

# sprawdzenie zgodności kolejności nazw oddziałów w obu bazach
any(suek_bd$.id != cke_bd$.id)

# wykres rozrzutu dla nieprzypisanych kodów
plot(suek_bd$bd_ratio, cke_bd$V1,
     main = "puste kody vs. nieprzypisane kody",
     xlab = "odsetek pustych kodów (baza suek)",
     ylab = "niewykorzystane kody (baza cke)")
```

Puste kody można interpretować jako braki dat urodzenia w bazie suek lub ich błędne wartości. Klasy z dużą ich liczbą zasługują na bliższe przyjrzenie. Jako kryterium przyjęto brak przypisania kodu ucznia dla więcej niż $1/3$ liczby uczniów w klasie lub, w wartościach bezwględnych, pięciu lub więcej uczniów. Ponizej znajdują się wykresy rozrzutu dla nr. z dziennika i kod ucznia wraz z naniesioną linią identyczności dla tak wyselekcjonowanych oddziałów.

```{r}
podejrzane = suek_bd[suek_bd$bd_ratio > 0.33 | suek_bd$bd_n > 4, ".id"]
l_ply(upd_suek3a[podejrzane], function(x){
    id_cke = unique(x$id_cke_kl)
    id_szk = unique(substr(x$id_ucz, 1, 3))
    plot(x$nr_dz6, x$kod_u_s_new,
         main = paste(c(unique(x$id_cke_kl), id_szk), collapse = "\n"),
         ylim = c(1, 39),
         xlim = c(1, 39))
    lines(0:40, 0:40, lty = 2)
    
    cat("\nklasa w bazie suek\n")
    print(x)
    cat("\nklasa w bazie cke\n")
    print(spr_list[[id_cke]])
  })

```


```{r}
############
upd_suek3a = Map(join_var, upd_suek, spr_2,
               MoreArgs = list(askBy.x = c("nr_dz6", "plec"),
                               askBy.y = c("kod_u_s", "plec"),
                               joinVar = "kod_u_s"))

hits3a = sum(sapply(upd_suek3a, function(x) {
          length(x$kod_u_s_new[!is.na(x$kod_u_s_new)])
        }))

# odsetek
hits3a/ nrow(suek)

zlacz = ldply(upd_suek3a)[, -1]

# uporządkowanie bazy ze względu na nr_dz6
zlacz = zlacz[order(zlacz$id_cke_kl, zlacz$nr_dz6), ]

zlacz[, "imie"] = sapply(strsplit(zlacz$imie_nazwisko, " "), "[", 1)
zlacz[, "nazwisko"] = sapply(strsplit(zlacz$imie_nazwisko, " "), "[", 2)

# oznaczenie uczniów o tym samym nazwisku w klasie
zlacz[, "rodz"] = 0
zlacz_list = dlply(zlacz, "id_cke_kl")

zlacz_list2 = lapply(zlacz_list, function(x) {
  ind1 = duplicated(x$nazwisko)
  ind2 = duplicated(x$nazwisko, fromLast = TRUE)
  
  x[ind1 | ind2, "rodz"] = 1
  x
  })
zlacz2 = ldply(zlacz_list2)[, -1]


bliz_kl = unique(zlacz2[(zlacz2$rodz == 1) & is.na(zlacz2$kod_u_s_new),
                        "id_cke_kl"] )


```



