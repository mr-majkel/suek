---
title: "Przyłączanie sprawdzianu do SUEKowych uczniów"
author: "Michał Modzelewski"
date: '`r Sys.Date()`'
output: pdf_document
---

```{r}
#setwd("~/SUEK/Projects/suek/testy osiagniec/spr_tos6")
library(plyr)
options(width = 90)
source("R/join_var.R")
```

# Wczytanie baz danych

```{r, cache = TRUE}

# sprawdzian
spr14 = read.csv2("data/sprawdzian_2014.csv", stringsAsFactors = FALSE)

# protokoł
suek_u = read.csv2("data/prot.csv", stringsAsFactors = FALSE)

# id_szkoly
suek_s = read.csv2("data/calosc.csv", stringsAsFactors = FALSE)
names(suek_s) = c("id_szk", "id_cke_s")

# rodzice etap 1
rodz_e1 = read.csv2("data/e1_rodzic.csv", stringsAsFactors = FALSE)[, c(1, 3)]
names(rodz_e1) = c("id_ucz", "data_ur")

# rodzice etap 2
rodz_e2 = read.csv2(paste0("data/SUEK II, ankiety rodziców, I etap, ",
                           "ankieta głównaDane.csv"),
                    stringsAsFactors = FALSE)[, c(3, 5)]
names(rodz_e2) = c("id_ucz", "data_ur")

# rodzice etap 3
rodz_e3 = read.csv2(paste0("data/SUEK E3 Baza ankiet rodziców",
                           " - niebieskie pełne CÓRKA Dane.csv"),
                    stringsAsFactors = FALSE)[, c(2, 4)]
names(rodz_e3) = c("id_ucz", "data_ur")

# rodzice etap 3 uzuepłniająca ankieta
rodz_e3u = read.csv2(paste0("data/SUEK E3 Baza ankiet rodziców",
                           " - niebieskie skrócone Dane.csv"),
                    stringsAsFactors = FALSE)[, c(2, 4)]
names(rodz_e3u) = c("id_ucz", "data_ur")

```

# Obróbka danych

1. Wyrzucenie uczniów, dla których nie zebrano informacji o numerze z dziennika. Są to w 100% uczniowie, którzy na etapie VII badania zostali wykluczeni, prawdopodobnie z powodu zmiany oddziału lub opuszczenia szkoły.

```{r}
# wyrzucenie uczniow o nrze z dziennika 97
suek_u = suek_u[suek_u$nr_dz6 != 97, ]

```

2. Poprawienie formatu daty urodzenia w bazach rodzicielskich z etapu 1, 2 i 3. Obcięcie godzin oraz zamiana "-" na ".".

```{r}
# obcięcie godzin i podmiana separatorów
# etap 1
rodz_e1$data_ur = gsub("-", ".", substr(rodz_e1$data_ur, 1, 10))
# etap 2
rodz_e2$data_ur = gsub("-", ".", substr(rodz_e2$data_ur, 1, 10))
# etap 3
rodz_e3$data_ur = gsub("-", ".", substr(rodz_e3$data_ur, 1, 10))
rodz_e3u$data_ur = gsub("-", ".", substr(rodz_e3u$data_ur, 1, 10))
```

3. Przyłączenie id\_cke do uczniów.

```{r}
# przylaczenie id cke do uczniow
suek = merge(suek_u, suek_s, all.x = TRUE)

```

4. Poprawienie id\_cke dla szkoły w Pilchowie. W naszych bazach figuruje jako szkoła w Tanowie (ID 034), klasa "B". Jest to jednak filia szkoły w Tanowie, czyli całkiem zewnętrzny byt. W związku z tym trzeba zmienić id\_cke, a także oznaczenie klasy na "A". 

```{r}
# podmiana ID CKE dla szkoły w pilchowie, ID 34 klasa B
suek[grep("^034.B", suek$id_ucz), "id_cke_s"] = "321104-11P1X"
suek[grep("^034.B", suek$id_ucz), "id_klasa6"] = "A"

```

5. Stworzenie identyfikatora dla klas w bazach sprawdzianowych i suekowych

```{r}
suek$id_cke_kl = paste(suek$id_cke_s, suek$id_klasa6, sep = "_")
spr14$id_cke_kl = paste(spr14$kod_s, spr14$klasa_s, sep = "_")
                          
```

6. Poprawienie identyfikatora uczniow z ankiety z etapu II

```{r}
id_list = strsplit(rodz_e2$id_ucz, ".", fixed = TRUE)
rodz_e2$id_ucz = sapply(id_list, function(x) {
    szk = sprintf("%03d", as.numeric(x[1]))
    kl = substr(x[2], 1, 1)
    ucz = x[4]
    paste(szk, kl, ucz, sep = ".")
  })

```

7. Przyłączenie daty urodzenia do bazy suekowej.

```{r}
# przylaczenie daty urodzenia
suek1 = merge(suek, rodz_e1, all.x = TRUE)

# uczniowie dla których nie ma daty urodzenia z pierwszego etapu
id_miss = suek1[is.na(suek1$data_ur), "id_ucz"]

# sprawdzenie czy uczniowie ci są obecni w innych bazach
any(id_miss %in% rodz_e2$id_ucz)
any(id_miss %in% rodz_e3$id_ucz)
any(id_miss %in% rodz_e3u$id_ucz)

# odjęcie uczniów, których nie ma w bazie z 3 etapu
id_3 = id_miss[id_miss %in% rodz_e3$id_ucz]

# dopisanie dat urodzenia dla uczniów z 3 etapu
suek1[match(id_3, suek1$id_ucz), "data_ur"] =
  rodz_e3[match(id_3, rodz_e3$id_ucz), "data_ur"]

# odjęcie uczniów, których nie ma w bazie z 3 etapu (ankieta uzup)
id_3u = id_miss[id_miss %in% rodz_e3u$id_ucz]

# dopisanie dat urodzenia dla uczniów z 3 etapu
suek1[match(id_3u, suek1$id_ucz), "data_ur"] =
  rodz_e3[match(id_3u, rodz_e3u$id_ucz), "data_ur"]

```

8. Wybranie klas suekowych z bazy sprawdzianowej oraz ograniczenie zakresu zbiorów do zmiennych identyfikujących.

```{r}
zm_spr = c("kod_u_s", "plec", "data_ur", "id_cke_kl")
spr = spr14[spr14$id_cke_kl %in% unique(suek$id_cke_kl), zm_spr]

# write.csv2(spr, "data/sprawdzian_suek.csv", row.names = FALSE)

zm_suek = c("imie_nazwisko", "nr_dz6", "plec", "data_ur", "id_cke_kl", "id_ucz")
suek2 = suek1[, zm_suek]

# posortowanie uczniów w obrębie klasy po nr z dziennika
suek2 = suek2[order(suek2$id_cke_kl, suek2$nr_dz6), ]
spr = spr[order(spr$id_cke_kl, spr$kod_u_s), ]

```

9. Wydzielenie imienia i nazwiska w bazie suekowej.

```{r}
suek2[, "imie"] = sapply(strsplit(suek2$imie_nazwisko, " "), "[", 1)
suek2[, "nazwisko"] = sapply(strsplit(suek2$imie_nazwisko, " "), "[", 2)
```

10. Oznaczenie potencjalnych bliźniaków jednopłciowych (osób o tym samym nazwisku).

```{r}
suek3 = ddply(suek2,"id_cke_kl", function(x) {
  ind1 = duplicated(x$nazwisko)
  ind2 = duplicated(x$nazwisko, fromLast = TRUE)
  
  x[, "rodz"] = 0
  x[ind1 | ind2, "rodz"] = 1
  x
  })

```

11. Uporządkowanie zmiennych w bazie suekowej.

```{r}
zm_suek2 = c("imie", "nazwisko", "nr_dz6", "plec", "data_ur", "id_cke_kl", "id_ucz", "rodz")

suek4 = suek3[, zm_suek2]

```

12. Nadpisanie dziwnych dat jako NA dla daty urodzenia

```{r}
sort(unique(suek4$data_ur))
suek4[grep("201[123]|9999", suek4$data_ur), "data_ur"] = NA

```

13. Sprawdzenie poprawności przypisania płci.

```{r}
# wystepujące imiona w bazie
sort(unique(suek4$imie))

# funkcja do wybierania imion
ends_with = function(x, letter, not = FALSE) {
    if (!not) { 
      substr(x, nchar(x), nchar(x)) %in% letter
    } else {
      !(substr(x, nchar(x), nchar(x)) %in% letter)
    }
  }
# kończące się na "a"
name_a = ends_with(suek4$imie, "a")
sort(unique(suek4[name_a, "imie"]))

# czy są jacyś chłopcy?
any(name_a & (suek4$plec != "K"))

# imiona oraz przypisana płeć dla uczniów z "a" na końcu
a_ind = name_a & (suek4$plec != "K")
suek4[a_ind,  c("imie", "plec", "id_ucz")]

# poprawienie płci dla Wiktorii
suek4[a_ind & suek4$imie == "Wiktoria", "plec"] = "K"

# kończące się na "o"
name_o = ends_with(suek4$imie, "o")
sort(unique(suek4[name_o, "imie"]))

# czy są jakieś dziewczynki?
any(name_o & (suek4$plec != "M"))

# kończące się na "e"
name_e = ends_with(suek4$imie, "e")
sort(unique(suek4[name_e, "imie"]))

# czy są jacyś chłopcy?
any(name_e & (suek4$plec != "K"))

# imiona oraz przypisana płeć dla uczniów z "e" na końcu
e_ind = name_e & (suek4$plec != "K")
suek4[e_ind,  c("imie", "plec")]

# kończące się na "i"
name_i = ends_with(suek4$imie, "i")
sort(unique(suek4[name_i, "imie"]))

# czy są jakieś dziewczynki?
any(name_i & (suek4$plec != "M"))

# kończące się na "y"
name_y = ends_with(suek4$imie, "y")
sort(unique(suek4[name_y, "imie"]))

# czy są jakieś dziewczynki?
any(name_y & (suek4$plec != "M"))

# niekończące się na "a", "o", "e", "i", "y"
name_other = ends_with(suek4$imie, c("a", "o", "e", "i", "y"), not = TRUE)
sort(unique(suek4[name_other, "imie"]))

# czy są jakieś dziewczynki?
any(name_other & (suek4$plec != "M"))

# imiona oraz przypisana płeć dla uczniów z innymi literami na końcu
other_ind = name_other & (suek4$plec != "M")
suek4[other_ind,  c("imie", "plec")]

```

# Łączenie sprawdzianu i danych suekowych

Proces łączenia polega na przypisaniu uczniom w bazie suekowej odpowiedniego nru z dziennika w bazie cke (numer ten identyfikuje uczniów jednoznacznie w obrębie klasy), zwanego dalej **kodem ucznia**.

W związku z tym, że nie dysponujemy żadnym dobrym identyfikatorem uczniów pomiędzy bazami danych, sprawdzianową i suekową, łączenie przeprowadzono w kilku krokach. Jako zmiennych identyfikujących użyto różnych podzbiorów z grupy trzech zmiennych: nru z dziennika w klasie 6, płci oraz daty urodzenia. Nr z dziennika oraz płeć są znane dla każdego ucznia w bazie suekowej i cke. Data urodzenia dla prawie wszystkich uczniów w bazie suekowej (~96 %).

```{r}
# odsetek braków danych na dacie urodzenia
length(suek4[is.na(suek4$data_ur), "id_ucz"]) / nrow(suek4)
```

Wyróżniono nastepujące podzbiory zmiennych do łączenia, stanowiące jednocześnie trzy **metody łączenia**:

1. data urodzenia, płeć i nr z dziennika;
2. data urodzenia i płeć;
3. nr z dziennika i płeć.

Dla każdego z podzbioru zmiennych możemy określić uczniów, którzy z ich pomocą zostali jednoznacznie wskazani w bazie cke (dalej zwanymi **uczniami zidentyfikowanymi**). Uczniowie zidentyfikowani za pomocą metody 1 stanowią podzbiór uczniów zidentyfikowanych za pomocą metody 3. Uczniowie zidentyfikowani za pomocą metody 2 i metody 3 stanowią zbiory niezależne, podobnie jak zbiory uczniów zidentyfikowanych za pomoca metody 1 i 2. Istnieje część wspólna dla zbiorów uczniów zidentyfikowanych za pomocą trzech metod.

Porównanie tych zbiorów (części wspólnych i rozłącznych) pozwala wyróżnić sześć, logicznie niezależnych podzbiorów uczniów w bazie suek:

A. Uczniowie, dla których każda z trzech metod łączenia daje ten sam efekt (część wspólna dla trzech zbiorów uczniów zidentyfikowanych).

B. Uczniowie, którzy są jednoznacznie identyfikowani tylko za pomocą metody 1 i 3 (odłączenie numeru z dziennika wskazuje innych uczniów w bazie cke lub nie pozwala na jednoznaczne przypisanie).

C. Uczniowie, którzy są jednoznacznie identyfikowani tylko za pomocą metody 2 (jest jeden uczeń w bazie cke z taką data urodzenia i płcią, ale ma inny kod ucznia niż nr z dziennika w bazie suek).

D. Uczniowie, którzy sa jednoznacznie identyfikowani tylko za pomocą metody 3 (jest jeden uczeń w bazie cke z taką płcią i kodem ucznia, ale ma inną datę urodzenia lub jej nie posiada).

E. Uczniowie, którym metoda 2 i 3 przypisuje odmienne kody uczniów (część wspólna pomiędzy zbiorem 2 i 3).

F. Uczniowie, którym żadna z metod nie pozwala na jednoznaczne przypisanie kodu ucznia (dopełnienie dla sumy trzech zbiorów; uczniowie z brakiem danych na dacie urodzenia lub uczniowie z datą urodzenia, która nie występuje w bazie cke [podejrzenie błędnej daty urodzenia]).

Sytuacja ta zobrazowana jest na poniższym rysunku.

![zbiory](zbiory.png)

Następnie wyznaczono wspomniane zbiory.

```{r, cache = TRUE}
# przyłączenie wg metody 1
met1 = join_var(suek4, spr,
                askBy.x = c("id_cke_kl", "nr_dz6", "data_ur", "plec"),
                askBy.y = c("id_cke_kl", "kod_u_s", "data_ur", "plec"),
                joinVar = "kod_u_s")
id_met1 = met1[!is.na(met1$kod_u_s_new), "id_ucz"]

# przyłączenie wg metody 2
met2 = join_var(suek4, spr,
                askBy.x = c("id_cke_kl", "data_ur", "plec"),
                askBy.y = c("id_cke_kl", "data_ur", "plec"),
                joinVar = "kod_u_s")
id_met2 = met2[!is.na(met2$kod_u_s_new), "id_ucz"]

# przyłączenie wg metody 3
met3 = join_var(suek4, spr,
                askBy.x = c("id_cke_kl", "nr_dz6", "plec"),
                askBy.y = c("id_cke_kl", "kod_u_s", "plec"),
                joinVar = "kod_u_s")
id_met3 = met3[!is.na(met3$kod_u_s_new), "id_ucz"]

# oznaczenie uczniów
zb_a = intersect(id_met1, id_met2)
zb_b = setdiff(id_met1, zb_a)
zb_c = setdiff(id_met2, id_met3)
zb_d = setdiff(id_met3, c(id_met2, zb_b))
zb_e = setdiff(intersect(id_met2, id_met3), zb_a)
zb_f = setdiff(suek4$id_ucz, union(id_met2, id_met3))
```

W kolejnym kroku sprawdzono zależności logiczne pomiędzy zbiorami.

```{r}
# sprawdzenie zbiorów
setequal(id_met1, c(zb_a, zb_b))
setequal(id_met2, c(zb_a, zb_c, zb_e))
setequal(id_met3, c(zb_a, zb_b, zb_d, zb_e))

# sprawdzenie kompletności i rozłączności zbiorów
length(suek4$id_ucz) == length(c(zb_a, zb_b, zb_c, zb_d, zb_e, zb_f))
```

I dodano zmienną do bazy.

```{r}
# dodanie zmiennej zbior do bazy suek
suek4$zbior = NA

suek4[suek4$id_ucz %in% zb_a, "zbior"] = "A"
suek4[suek4$id_ucz %in% zb_b, "zbior"] = "B"
suek4[suek4$id_ucz %in% zb_c, "zbior"] = "C"
suek4[suek4$id_ucz %in% zb_d, "zbior"] = "D"
suek4[suek4$id_ucz %in% zb_e, "zbior"] = "E"
suek4[suek4$id_ucz %in% zb_f, "zbior"] = "F"
```

Rozkład liczebności uczniów w podziale na poszczególne zbiory.

```{r} 
table(suek4$zbior, useNA = "always")
```

I rozkład procentowy.

```{r}
round(table(suek4$zbior)/nrow(suek4), 4) * 100
```

W oddziałach, w których uczniowie z grupy "A" stanowią 100 % liczebności uczniów, nr z dziennika obecny w bazie suek jest tożsamy z kodem ucznia. W pozostałych oddziałach klasowych sytuacja jest mniej klarowna.

```{r}
klasy = ddply(suek4, "id_cke_kl", function(x) {
    data.frame(A = sum(x$zbior == "A"),
               B = sum(x$zbior == "B"),
               C = sum(x$zbior == "C"),
               D = sum(x$zbior == "D"),
               E = sum(x$zbior == "E"),
               F = sum(x$zbior == "F"),
               n = nrow(x))
  })

klasy_prob = klasy[klasy$A/klasy$n != 1, ]
```

```{r, fig.height = 1.75, fig.keep='high', dev.args = list(pointsize = 8)}
par(mfrow = c(1, 3))
nines = (nrow(klasy_prob) %/% 3) + ifelse((nrow(klasy_prob) %% 3) > 0, 1, 0)
for(i in 1:nines) {
  ind = ((i - 1) * 3) + c(1:3)
  ind = ind[which(ind <= nrow(klasy_prob))]
  d_ply(klasy_prob[ind,], "id_cke_kl", function(kl) {
    mat = as.matrix((kl[, -c(1, 8)]/kl[, 8]))
    barplot(mat, width = 0.1,  ylim = c(0, 1), main = kl[ ,1],
            mar = c(2,2,2,2))
    })
}
```

A + B

```{r}
a_b = klasy[klasy$A != klasy$n &
              klasy$A + klasy$B == klasy$n, 1]

suek4[suek4$id_cke_kl == a_b[3], -c(1, 2)]
```

A + D

```{r}
a_d = klasy[klasy$A != klasy$n &
              klasy$A + klasy$D == klasy$n, 1]

suek4[suek4$id_cke_kl == a_d[2], -c(1, 2)]
```

A + C

```{r}
a_c = klasy[klasy$A != klasy$n &
              klasy$A + klasy$C == klasy$n, 1]

suek4[suek4$id_cke_kl == a_c[1], -c(1, 2)]
```

A + F

```{r}
a_f = klasy[klasy$A != klasy$n &
              klasy$A + klasy$F == klasy$n, 1]

suek4[suek4$id_cke_kl == a_f[1], -c(1, 2)]
```

A + E

```{r}
a_e = klasy[klasy$A != klasy$n &
              klasy$A + klasy$E == klasy$n, 1]

suek4[suek4$id_cke_kl == a_e[1], ]
spr[spr$id_cke_kl == a_e[1], ]
```

W tym jednym przypadku wziąć z bazy sprawdzianowej.


# Wnioski dla dalszych prac na zbiorach

1. Wyróżnić szkołę w Pilchowie poprzez nadanie nowego id szkoły. Zmiana oznaczenia klasy 6 na "A".
2. Poprawić płeć uczennicy o id 133.B.1048 (z "M" na "K").